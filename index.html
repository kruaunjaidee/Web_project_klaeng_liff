<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF - ส่งข้อความหลากหลายประเภท</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-100 p-4">
    <div id="app" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-xl font-bold mb-4 text-center">ส่งข้อความหลากหลายประเภท</h1>
        <div id="loading" class="text-center text-gray-600">กำลังโหลด LIFF...</div>
        <form id="messageForm" class="space-y-6 hidden">
            <div id="messageBlocks">
                <div class="border p-4 rounded-md message-block">
                    <label class="block text-sm font-medium text-gray-700">ประเภทข้อความ</label>
                    <select class="msg-type w-full p-2 border rounded-md mb-2" onchange="updateFields(this)">
                        <option value="TEXT">ข้อความ (Text)</option>
                        <option value="FLEX">Flex Message</option>
                        <option value="VIDEO">วิดีโอ (Video)</option>
                        <option value="TEMPLATE">เทมเพลต (Template)</option>
                        <option value="IMAGE">รูปภาพ (Image)</option>
                        <option value="IMAGEMAP">Imagemap</option>
                        <option value="AUDIO">เสียง (Audio)</option>
                        <option value="STICKER">สติกเกอร์ (Sticker)</option>
                        <option value="LOCATION">ตำแหน่ง (Location)</option>
                    </select>
                    <div class="fields space-y-2"></div>
                </div>
            </div>
            <button type="button" id="addMessage" class="w-full bg-green-500 text-white p-2 rounded-md hover:bg-green-600">เพิ่มข้อความ (สูงสุด 3)</button>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">เลือกจำนวนข้อความที่จะส่ง</label>
                <select id="msgCount" class="w-full p-2 border rounded-md">
                    <option value="1">ส่ง 1 ข้อความ</option>
                    <option value="2">ส่ง 2 ข้อความ</option>
                    <option value="3">ส่ง 3 ข้อความ</option>
                </select>
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600">ส่งข้อความ</button>
        </form>
        <p id="status" class="mt-4 text-center text-gray-600"></p>
    </div>

    <script>
        const app = document.getElementById('app');
        const loading = document.getElementById('loading');
        const form = document.getElementById('messageForm');
        const status = document.getElementById('status');
        const messageBlocks = document.getElementById('messageBlocks');
        let blockCount = 1;

        // ฟังก์ชันเริ่มต้น LIFF
        liff.init({
            liffId: '2005780370-zjBDd5aK' // แทนที่ด้วย LIFF ID ของคุณ
        })
        .then(() => {
            loading.textContent = 'LIFF โหลดสำเร็จ กำลังตรวจสอบสภาพแวดล้อม...';
            if (!liff.isInClient()) {
                loading.classList.add('hidden');
                status.textContent = 'กรุณาเปิดใน LINE App เท่านั้น (ใช้ line://app/YOUR_LIFF_ID)';
                if (!liff.isLoggedIn()) {
                    status.textContent += ' กำลังพยายามล็อกอิน...';
                    liff.login(); // จะ redirect ไป LINE Login หากไม่อยู่ใน LINE App
                }
            } else {
                loading.classList.add('hidden');
                form.classList.remove('hidden');
                updateFields(messageBlocks.querySelector('.msg-type'));
                status.textContent = 'พร้อมใช้งานใน LINE App';
            }
        })
        .catch((err) => {
            loading.classList.add('hidden');
            status.textContent = `เกิดข้อผิดพลาดในการโหลด LIFF: ${err.code} - ${err.message}`;
            console.log('LIFF Error:', err.code, err.message);
        });

        function updateFields(select) {
            const block = select.closest('.message-block');
            const fields = block.querySelector('.fields');
            const type = select.value;
            fields.innerHTML = '';

            switch (type) {
                case 'TEXT':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="พิมพ์ข้อความ"></textarea>';
                    break;
                case 'FLEX':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Flex Message"></textarea>';
                    break;
                case 'VIDEO':
                    fields.innerHTML = '<input type="url" class="content w-full p-2 border rounded-md" placeholder="URL วิดีโอ"><input type="url" class="preview w-full p-2 border rounded-md" placeholder="URL ภาพตัวอย่าง">';
                    break;
                case 'TEMPLATE':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Template"></textarea>';
                    break;
                case 'IMAGE':
                    fields.innerHTML = '<input type="url" class="content w-full p-2 border rounded-md" placeholder="URL รูปภาพ"><input type="url" class="preview w-full p-2 border rounded-md" placeholder="URL ภาพตัวอย่าง">';
                    break;
                case 'IMAGEMAP':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Imagemap"></textarea>';
                    break;
                case 'AUDIO':
                    fields.innerHTML = '<input type="url" class="content w-full p-2 border rounded-md" placeholder="URL เสียง"><input type="number" class="preview w-full p-2 border rounded-md" placeholder="ระยะเวลา (มิลลิวินาที)">';
                    break;
                case 'STICKER':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="Package ID"><input type="text" class="preview w-full p-2 border rounded-md" placeholder="Sticker ID">';
                    break;
                case 'LOCATION':
                    fields.innerHTML = '<input type="text" class="locName w-full p-2 border rounded-md" placeholder="ชื่อสถานที่"><input type="text" class="address w-full p-2 border rounded-md" placeholder="ที่อยู่"><input type="number" class="content w-full p-2 border rounded-md" placeholder="ละติจูด"><input type="number" class="preview w-full p-2 border rounded-md" placeholder="ลองจิจูด">';
                    break;
            }
        }

        document.getElementById('addMessage').addEventListener('click', () => {
            if (blockCount < 3) {
                blockCount++;
                const newBlock = messageBlocks.children[0].cloneNode(true);
                newBlock.querySelector('.fields').innerHTML = '';
                updateFields(newBlock.querySelector('.msg-type'));
                messageBlocks.appendChild(newBlock);
                document.getElementById('msgCount').value = blockCount;
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!liff.isInClient()) {
                status.textContent = 'ส่งข้อความได้เฉพาะใน LINE App เท่านั้น';
                return;
            }

            const blocks = messageBlocks.querySelectorAll('.message-block');
            const msgCount = parseInt(document.getElementById('msgCount').value);
            const messages = [];

            blocks.forEach((block, index) => {
                if (index >= msgCount) return;
                const type = block.querySelector('.msg-type').value;
                const content = block.querySelector('.content')?.value || '';
                const preview = block.querySelector('.preview')?.value || '';
                const locName = block.querySelector('.locName')?.value || '';
                const address = block.querySelector('.address')?.value || '';

                let msgToBot = {};
                switch (type) {
                    case "TEXT":
                        msgToBot = { type: "text", text: content };
                        break;
                    case "FLEX":
                        msgToBot = { type: "flex", altText: "This is a Flex Message", contents: JSON.parse(content) };
                        break;
                    case "VIDEO":
                        msgToBot = { type: "video", originalContentUrl: content, previewImageUrl: preview };
                        break;
                    case "TEMPLATE":
                        msgToBot = JSON.parse(content);
                        break;
                    case "IMAGE":
                        msgToBot = { type: "image", originalContentUrl: content, previewImageUrl: preview };
                        break;
                    case "IMAGEMAP":
                        msgToBot = JSON.parse(content);
                        break;
                    case "AUDIO":
                        msgToBot = { type: "audio", originalContentUrl: content, duration: parseInt(preview) };
                        break;
                    case "STICKER":
                        msgToBot = { type: "sticker", packageId: content, stickerId: preview };
                        break;
                    case "LOCATION":
                        msgToBot = { type: "location", title: locName, address: address, latitude: parseFloat(content), longitude: parseFloat(preview) };
                        break;
                }
                if (Object.keys(msgToBot).length) messages.push(msgToBot);
            });

            if (!messages.length) {
                status.textContent = "กรุณากรอกข้อมูลอย่างน้อย 1 ข้อความ";
                return;
            }

            status.textContent = "กำลังส่ง...";
            try {
                // ส่งข้อความผ่าน LIFF
                await liff.sendMessages(messages);

                // บันทึกข้อมูลลง Google Sheet
                const response = await fetch('YOUR_GOOGLE_APPS_SCRIPT_URL', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages })
                });

                const result = await response.json();
                if (result.status === 'success') {
                    status.textContent = "ส่งข้อความเรียบร้อยและบันทึกใน Google Sheet";
                    form.reset();
                    updateFields(messageBlocks.querySelector('.msg-type'));
                } else {
                    status.textContent = "เกิดข้อผิดพลาดในการบันทึก: " + result.message;
                }
            } catch (error) {
                status.textContent = "เกิดข้อผิดพลาด: " + error.message;
                console.log('Error:', error);
            }
        });
    </script>
</body>
</html>
