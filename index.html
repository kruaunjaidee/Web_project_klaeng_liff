<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF - ส่งข้อความ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 p-4">
    <div id="app" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-xl font-bold mb-4 text-center">ส่งข้อความ 5 ข้อความพร้อมกัน</h1>
        <div id="loading" class="text-center text-gray-600">กำลังโหลด LIFF...</div>
        <form id="messageForm" class="space-y-6 hidden">
            <div id="messageBlocks">
                <div class="border p-4 rounded-md message-block">
                    <label class="block text-sm font-medium text-gray-700">ข้อความ 1</label>
                    <select class="msg-type w-full p-2 border rounded-md mb-2" onchange="updateFields(this)">
                        <option value="TEXT">ข้อความ (Text)</option>
                        <option value="FLEX">Flex Message</option>
                        <option value="VIDEO">วิดีโอ (Video)</option>
                        <option value="TEMPLATE">เทมเพลต (Template)</option>
                        <option value="IMAGE">รูปภาพ (Image)</option>
                        <option value="IMAGEMAP">Imagemap</option>
                        <option value="AUDIO">เสียง (Audio)</option>
                        <option value="STICKER">สติกเกอร์ (Sticker)</option>
                        <option value="LOCATION">ตำแหน่ง (Location)</option>
                    </select>
                    <div class="fields space-y-2"></div>
                </div>
                <div class="border p-4 rounded-md message-block">
                    <label class="block text-sm font-medium text-gray-700">ข้อความ 2</label>
                    <select class="msg-type w-full p-2 border rounded-md mb-2" onchange="updateFields(this)">
                        <option value="TEXT">ข้อความ (Text)</option>
                        <option value="FLEX">Flex Message</option>
                        <option value="VIDEO">วิดีโอ (Video)</option>
                        <option value="TEMPLATE">เทมเพลต (Template)</option>
                        <option value="IMAGE">รูปภาพ (Image)</option>
                        <option value="IMAGEMAP">Imagemap</option>
                        <option value="AUDIO">เสียง (Audio)</option>
                        <option value="STICKER">สติกเกอร์ (Sticker)</option>
                        <option value="LOCATION">ตำแหน่ง (Location)</option>
                    </select>
                    <div class="fields space-y-2"></div>
                </div>
                <div class="border p-4 rounded-md message-block">
                    <label class="block text-sm font-medium text-gray-700">ข้อความ 3</label>
                    <select class="msg-type w-full p-2 border rounded-md mb-2" onchange="updateFields(this)">
                        <option value="TEXT">ข้อความ (Text)</option>
                        <option value="FLEX">Flex Message</option>
                        <option value="VIDEO">วิดีโอ (Video)</option>
                        <option value="TEMPLATE">เทมเพลต (Template)</option>
                        <option value="IMAGE">รูปภาพ (Image)</option>
                        <option value="IMAGEMAP">Imagemap</option>
                        <option value="AUDIO">เสียง (Audio)</option>
                        <option value="STICKER">สติกเกอร์ (Sticker)</option>
                        <option value="LOCATION">ตำแหน่ง (Location)</option>
                    </select>
                    <div class="fields space-y-2"></div>
                </div>
                <div class="border p-4 rounded-md message-block">
                    <label class="block text-sm font-medium text-gray-700">ข้อความ 4</label>
                    <select class="msg-type w-full p-2 border rounded-md mb-2" onchange="updateFields(this)">
                        <option value="TEXT">ข้อความ (Text)</option>
                        <option value="FLEX">Flex Message</option>
                        <option value="VIDEO">วิดีโอ (Video)</option>
                        <option value="TEMPLATE">เทมเพลต (Template)</option>
                        <option value="IMAGE">รูปภาพ (Image)</option>
                        <option value="IMAGEMAP">Imagemap</option>
                        <option value="AUDIO">เสียง (Audio)</option>
                        <option value="STICKER">สติกเกอร์ (Sticker)</option>
                        <option value="LOCATION">ตำแหน่ง (Location)</option>
                    </select>
                    <div class="fields space-y-2"></div>
                </div>
                <div class="border p-4 rounded-md message-block">
                    <label class="block text-sm font-medium text-gray-700">ข้อความ 5</label>
                    <select class="msg-type w-full p-2 border rounded-md mb-2" onchange="updateFields(this)">
                        <option value="TEXT">ข้อความ (Text)</option>
                        <option value="FLEX">Flex Message</option>
                        <option value="VIDEO">วิดีโอ (Video)</option>
                        <option value="TEMPLATE">เทมเพลต (Template)</option>
                        <option value="IMAGE">รูปภาพ (Image)</option>
                        <option value="IMAGEMAP">Imagemap</option>
                        <option value="AUDIO">เสียง (Audio)</option>
                        <option value="STICKER">สติกเกอร์ (Sticker)</option>
                        <option value="LOCATION">ตำแหน่ง (Location)</option>
                    </select>
                    <div class="fields space-y-2"></div>
                </div>
            </div>
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600">ส่งข้อความ</button>
        </form>
        <p id="status" class="mt-4 text-center text-gray-600"></p>
    </div>

    <script>
        const app = document.getElementById('app');
        const loading = document.getElementById('loading');
        const form = document.getElementById('messageForm');
        const status = document.getElementById('status');
        const messageBlocks = document.getElementById('messageBlocks');

        // เริ่มต้น LIFF
        liff.init({
            liffId: '2005780370-zjBDd5aK'
        })
        .then(() => {
            loading.classList.add('hidden');
            form.classList.remove('hidden');
            messageBlocks.querySelectorAll('.msg-type').forEach(updateFields);
            status.textContent = liff.isInClient() ? 'พร้อมใช้งานใน LINE App' : 'เปิดในเบราว์เซอร์ (ส่งข้อความได้เฉพาะใน LINE App)';
        })
        .catch((err) => {
            loading.classList.add('hidden');
            status.textContent = `เกิดข้อผิดพลาดในการโหลด LIFF: ${err.code} - ${err.message}`;
            console.log('LIFF Error:', err.code, err.message);
        });

        function updateFields(select) {
            const block = select.closest('.message-block');
            const fields = block.querySelector('.fields');
            const type = select.value;
            fields.innerHTML = '';

            switch (type) {
                case 'TEXT':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="พิมพ์ข้อความ"></textarea>';
                    break;
                case 'FLEX':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Flex Message"></textarea>';
                    break;
                case 'VIDEO':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="URL วิดีโอ หรือ Google Drive File ID"><input type="text" class="preview w-full p-2 border rounded-md" placeholder="URL ภาพตัวอย่าง หรือ File ID">';
                    break;
                case 'TEMPLATE':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Template"></textarea>';
                    break;
                case 'IMAGE':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="Google Drive File ID รูปภาพ"><input type="text" class="preview w-full p-2 border rounded-md" placeholder="Google Drive File ID ภาพตัวอย่าง">';
                    break;
                case 'IMAGEMAP':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Imagemap"></textarea>';
                    break;
                case 'AUDIO':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="URL เสียง หรือ Google Drive File ID"><input type="number" class="preview w-full p-2 border rounded-md" placeholder="ระยะเวลา (มิลลิวินาที)">';
                    break;
                case 'STICKER':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="Package ID"><input type="text" class="preview w-full p-2 border rounded-md" placeholder="Sticker ID">';
                    break;
                case 'LOCATION':
                    fields.innerHTML = '<input type="text" class="locName w-full p-2 border rounded-md" placeholder="ชื่อสถานที่"><input type="text" class="address w-full p-2 border rounded-md" placeholder="ที่อยู่"><input type="text" class="latitude w-full p-2 border rounded-md" placeholder="ละติจูด"><input type="text" class="longitude w-full p-2 border rounded-md" placeholder="ลองจิจูด">';
                    break;
            }
        }

        function processUrl(input, type) {
            if (!input) return '';
            if (input.includes('drive.google.com')) {
                const match = input.match(/\/d\/([a-zA-Z0-9_-]+)/);
                const fileId = match ? match[1] : null;
                return fileId ? `https://lh3.googleusercontent.com/d/${fileId}` : input;
            }
            return input;
        }

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const blocks = messageBlocks.querySelectorAll('.message-block');
            const messages = [];

            blocks.forEach((block) => {
                const type = block.querySelector('.msg-type').value;
                const content = block.querySelector('.content')?.value || '';
                const preview = block.querySelector('.preview')?.value || '';
                const locName = block.querySelector('.locName')?.value || '';
                const address = block.querySelector('.address')?.value || '';
                const latitude = block.querySelector('.latitude')?.value || '';
                const longitude = block.querySelector('.longitude')?.value || '';

                let msgToBot = {};
                switch (type) {
                    case "TEXT":
                        if (content) msgToBot = { type: "text", text: content };
                        break;
                    case "FLEX":
                        if (content) msgToBot = { type: "flex", altText: "This is a Flex Message", contents: JSON.parse(content) };
                        break;
                    case "VIDEO":
                        if (content && preview) msgToBot = { 
                            type: "video", 
                            originalContentUrl: processUrl(content, 'VIDEO'), 
                            previewImageUrl: processUrl(preview, 'IMAGE') 
                        };
                        break;
                    case "TEMPLATE":
                        if (content) msgToBot = JSON.parse(content);
                        break;
                    case "IMAGE":
                        if (content && preview) msgToBot = { 
                            type: "image", 
                            originalContentUrl: processUrl(content, 'IMAGE'), 
                            previewImageUrl: processUrl(preview, 'IMAGE') 
                        };
                        break;
                    case "IMAGEMAP":
                        if (content) msgToBot = JSON.parse(content);
                        break;
                    case "AUDIO":
                        if (content && preview) msgToBot = { 
                            type: "audio", 
                            originalContentUrl: processUrl(content, 'AUDIO'), 
                            duration: parseInt(preview) 
                        };
                        break;
                    case "STICKER":
                        if (content && preview) msgToBot = { type: "sticker", packageId: content, stickerId: preview };
                        break;
                    case "LOCATION":
                        if (locName && address && latitude && longitude) msgToBot = { 
                            type: "location", 
                            title: locName, 
                            address: address, 
                            latitude: parseFloat(latitude), 
                            longitude: parseFloat(longitude) 
                        };
                        break;
                }
                if (Object.keys(msgToBot).length) messages.push(msgToBot);
            });

            if (messages.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกข้อมูล',
                    text: 'กรุณากรอกข้อมูลอย่างน้อย 1 ข้อความ',
                });
                return;
            }

            Swal.fire({
                title: 'กำลังส่งข้อความ...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            if (liff.isInClient()) {
                liff.sendMessages(messages.slice(0, 5))
                    .then(() => {
                        Swal.fire({
                            icon: 'success',
                            title: 'สำเร็จ!',
                            text: 'ส่งข้อความเรียบร้อยแล้ว',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        form.reset();
                        messageBlocks.querySelectorAll('.msg-type').forEach(updateFields);
                    })
                    .catch((error) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: `ไม่สามารถส่งข้อความได้: ${error.message}`,
                        });
                        console.log('LIFF Send Error:', error);
                    });
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'ไม่สามารถส่งได้',
                    text: 'กรุณาเปิดใน LINE App เพื่อส่งข้อความ',
                });
            }
        });
    </script>
</body>
</html>
