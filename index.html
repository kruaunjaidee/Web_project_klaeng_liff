<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF - ส่งข้อความ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="bg-gray-100 p-4">
    <div id="app" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-xl font-bold mb-4 text-center">ส่งข้อความ</h1>
        <div id="loading" class="text-center text-gray-600">กำลังโหลด LIFF...</div>
        <form id="messageForm" class="space-y-6 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">เลือกจำนวนข้อความ</label>
                <select id="msgCount" class="w-full p-2 border rounded-md" onchange="adjustMessageBlocks()">
                    <option value="1">1 ข้อความ</option>
                    <option value="2">2 ข้อความ</option>
                    <option value="3">3 ข้อความ</option>
                    <option value="4">4 ข้อความ</option>
                    <option value="5">5 ข้อความ</option>
                </select>
            </div>
            <div id="messageBlocks" class="space-y-4"></div>
            <button type="button" id="shareTargetPicker" class="w-full bg-yellow-500 text-white p-2 rounded-md hover:bg-yellow-600 mb-2">เลือกไฟล์จาก Share Target</button>
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600">ส่งข้อความ</button>
        </form>
        <p id="status" class="mt-4 text-center text-gray-600"></p>
    </div>

    <script>
        const app = document.getElementById('app');
        const loading = document.getElementById('loading');
        const form = document.getElementById('messageForm');
        const status = document.getElementById('status');
        const messageBlocks = document.getElementById('messageBlocks');
        let currentBlockIndex = 0;

        // เริ่มต้น LIFF
        liff.init({
            liffId: '2005780370-zjBDd5aK'
        })
        .then(() => {
            loading.classList.add('hidden');
            form.classList.remove('hidden');
            adjustMessageBlocks(); // โหลดช่องเริ่มต้น
            status.textContent = liff.isInClient() ? 'พร้อมใช้งานใน LINE App' : 'เปิดในเบราว์เซอร์ (ส่งข้อความได้เฉพาะใน LINE App)';
        })
        .catch((err) => {
            loading.classList.add('hidden');
            status.textContent = `เกิดข้อผิดพลาดในการโหลด LIFF: ${err.code} - ${err.message}`;
            console.log('LIFF Error:', err.code, err.message);
            form.classList.remove('hidden');
        });

        function updateFields(select) {
            const block = select.closest('.message-block');
            const fields = block.querySelector('.fields');
            const type = select.value;
            fields.innerHTML = '';

            switch (type) {
                case 'TEXT':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="พิมพ์ข้อความ"></textarea>';
                    break;
                case 'FLEX':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Flex Message"></textarea>';
                    break;
                case 'VIDEO':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="URL วิดีโอ หรือ Google Drive File ID"><input type="text" class="preview w-full p-2 border rounded-md" placeholder="URL ภาพตัวอย่าง หรือ File ID">';
                    break;
                case 'TEMPLATE':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Template"></textarea>';
                    break;
                case 'IMAGE':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="Google Drive File ID รูปภาพ"><input type="text" class="preview w-full p-2 border rounded-md" placeholder="Google Drive File ID ภาพตัวอย่าง">';
                    break;
                case 'IMAGEMAP':
                    fields.innerHTML = '<textarea class="content w-full p-2 border rounded-md" placeholder="JSON ของ Imagemap"></textarea>';
                    break;
                case 'AUDIO':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="URL เสียง หรือ Google Drive File ID"><input type="number" class="preview w-full p-2 border rounded-md" placeholder="ระยะเวลา (มิลลิวินาที)">';
                    break;
                case 'STICKER':
                    fields.innerHTML = '<input type="text" class="content w-full p-2 border rounded-md" placeholder="Package ID"><input type="text" class="preview w-full p-2 border rounded-md" placeholder="Sticker ID">';
                    break;
                case 'LOCATION':
                    fields.innerHTML = '<input type="text" class="locName w-full p-2 border rounded-md" placeholder="ชื่อสถานที่"><input type="text" class="address w-full p-2 border rounded-md" placeholder="ที่อยู่"><input type="text" class="latitude w-full p-2 border rounded-md" placeholder="ละติจูด"><input type="text" class="longitude w-full p-2 border rounded-md" placeholder="ลองจิจูด">';
                    break;
            }
        }

        // ฟังก์ชันปรับจำนวนช่อง Message Block
        function adjustMessageBlocks() {
            const desiredCount = parseInt(document.getElementById('msgCount').value);
            const currentCount = messageBlocks.children.length;

            // ลบช่องเกิน
            while (currentCount > desiredCount) {
                messageBlocks.removeChild(messageBlocks.lastChild);
            }

            // เพิ่มช่องใหม่ให้ครบ
            while (currentCount < desiredCount) {
                const newBlock = document.createElement('div');
                newBlock.className = 'border p-4 rounded-md message-block';
                newBlock.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">ข้อความ ${currentCount + 1}</label>
                    <select class="msg-type w-full p-2 border rounded-md mb-2" onchange="updateFields(this)">
                        <option value="TEXT">ข้อความ (Text)</option>
                        <option value="FLEX">Flex Message</option>
                        <option value="VIDEO">วิดีโอ (Video)</option>
                        <option value="TEMPLATE">เทมเพลต (Template)</option>
                        <option value="IMAGE">รูปภาพ (Image)</option>
                        <option value="IMAGEMAP">Imagemap</option>
                        <option value="AUDIO">เสียง (Audio)</option>
                        <option value="STICKER">สติกเกอร์ (Sticker)</option>
                        <option value="LOCATION">ตำแหน่ง (Location)</option>
                    </select>
                    <div class="fields space-y-2"></div>
                `;
                messageBlocks.appendChild(newBlock);
                updateFields(newBlock.querySelector('.msg-type'));
            }
        }

        // ฟังก์ชันดึง File ID จาก Google Drive URL
        function extractFileId(url) {
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }

        // ฟังก์ชันตรวจสอบและแปลง URL
        function processUrl(input, type) {
            if (!input) return '';
            if (input.includes('drive.google.com')) {
                const fileId = extractFileId(input);
                return fileId ? `https://lh3.googleusercontent.com/d/${fileId}` : input;
            }
            return input;
        }

        // Share Target Picker
        document.getElementById('shareTargetPicker').addEventListener('click', () => {
            if (!liff.isInClient()) {
                status.textContent = "Share Target Picker ใช้ได้เฉพาะใน LINE App";
                return;
            }

            liff.shareTargetPicker([
                { type: "text", text: "เลือกไฟล์จาก Google Drive หรือ URL เพื่อใส่ในช่องข้อความ" }
            ])
            .then((result) => {
                if (result) {
                    const sharedText = result[0]?.text || '';
                    const fileId = extractFileId(sharedText) || sharedText;
                    if (fileId) {
                        const blocks = messageBlocks.querySelectorAll('.message-block');
                        const currentBlock = blocks[currentBlockIndex];
                        const type = currentBlock.querySelector('.msg-type').value;

                        if (['VIDEO', 'IMAGE', 'AUDIO'].includes(type)) {
                            const contentField = currentBlock.querySelector('.content');
                            contentField.value = fileId;
                            status.textContent = `ใส่ข้อมูล: ${fileId} ในข้อความ ${currentBlockIndex + 1}`;
                        } else {
                            status.textContent = "กรุณาเลือกประเภท VIDEO, IMAGE หรือ AUDIO ก่อนใช้ Share Target";
                        }

                        currentBlockIndex = (currentBlockIndex + 1) % blocks.length;
                    } else {
                        status.textContent = "ไม่พบ File ID หรือ URL ที่ถูกต้องในลิงก์ที่แชร์";
                    }
                }
            })
            .catch((error) => {
                status.textContent = "เกิดข้อผิดพลาดใน Share Target Picker: " + error.message;
                console.log('Share Target Error:', error);
            });
        });

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const blocks = messageBlocks.querySelectorAll('.message-block');
            const messages = [];

            blocks.forEach((block) => {
                const type = block.querySelector('.msg-type').value;
                const content = block.querySelector('.content')?.value || '';
                const preview = block.querySelector('.preview')?.value || '';
                const locName = block.querySelector('.locName')?.value || '';
                const address = block.querySelector('.address')?.value || '';
                const latitude = block.querySelector('.latitude')?.value || '';
                const longitude = block.querySelector('.longitude')?.value || '';

                let msgToBot = {};
                switch (type) {
                    case "TEXT":
                        if (content) msgToBot = { type: "text", text: content };
                        break;
                    case "FLEX":
                        if (content) msgToBot = { type: "flex", altText: "This is a Flex Message", contents: JSON.parse(content) };
                        break;
                    case "VIDEO":
                        if (content && preview) msgToBot = { 
                            type: "video", 
                            originalContentUrl: processUrl(content, 'VIDEO'), 
                            previewImageUrl: processUrl(preview, 'IMAGE') 
                        };
                        break;
                    case "TEMPLATE":
                        if (content) msgToBot = JSON.parse(content);
                        break;
                    case "IMAGE":
                        if (content && preview) msgToBot = { 
                            type: "image", 
                            originalContentUrl: processUrl(content, 'IMAGE'), 
                            previewImageUrl: processUrl(preview, 'IMAGE') 
                        };
                        break;
                    case "IMAGEMAP":
                        if (content) msgToBot = JSON.parse(content);
                        break;
                    case "AUDIO":
                        if (content && preview) msgToBot = { 
                            type: "audio", 
                            originalContentUrl: processUrl(content, 'AUDIO'), 
                            duration: parseInt(preview) 
                        };
                        break;
                    case "STICKER":
                        if (content && preview) msgToBot = { type: "sticker", packageId: content, stickerId: preview };
                        break;
                    case "LOCATION":
                        if (locName && address && latitude && longitude) msgToBot = { 
                            type: "location", 
                            title: locName, 
                            address: address, 
                            latitude: parseFloat(latitude), 
                            longitude: parseFloat(longitude) 
                        };
                        break;
                }
                if (Object.keys(msgToBot).length) messages.push(msgToBot);
            });

            if (messages.length === 0) {
                status.textContent = "กรุณากรอกข้อมูลอย่างน้อย 1 ข้อความ";
                return;
            }

            status.textContent = "กำลังส่ง...";

            if (liff.isInClient()) {
                liff.sendMessages(messages)
                    .then(() => {
                        status.textContent = "ส่งข้อความสำเร็จ";
                        form.reset();
                        adjustMessageBlocks();
                    })
                    .catch((error) => {
                        status.textContent = "เกิดข้อผิดพลาดในการส่งข้อความ: " + error.message;
                        console.log('LIFF Send Error:', error);
                    });
            } else {
                status.textContent = "ส่งข้อความได้เฉพาะใน LINE App เท่านั้น";
            }
        });
    </script>
</body>
</html>
